<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing - Espacio Cocrearte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#181f2a',
                        darkcard: '#232b3b',
                        darkborder: '#313a4d',
                        darktext: '#d1d5db'
                    }
                }
            }
        };
    </script>
    <link rel="icon" href="public/favicon.ico" type="image/x-icon">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body class="dark bg-darkbg text-gray-100 min-h-screen">
    <header class="bg-gradient-to-br from-primary-500 to-primary-700 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <a href="index.html" class="flex items-center space-x-3 text-white hover:text-primary-100 transition-all duration-200 transform hover:scale-105">
                    <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </div>
                    <span class="font-semibold text-lg">Volver</span>
                </a>
                <div class="w-px h-8 bg-white bg-opacity-30"></div>
                <div class="flex items-center space-x-3">
                    <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <span class="text-2xl font-bold text-white">Marketing</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-white text-sm opacity-90">Panel de Administración</span>
                <button id="logoutBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 backdrop-blur-sm">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 bg-darkbg">
        <div class="mb-8">
            <nav class="flex items-center space-x-2 text-sm text-gray-400 mb-4">
                <a href="index.html" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Inicio</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <span class="text-gray-300">Marketing</span>
            </nav>
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold text-white mb-2">Panel de Marketing</h1>
                    <p class="text-lg text-gray-400">Gestiona y analiza datos demográficos de consultas</p>
                </div>
                <div class="flex gap-4">
                    <button id="btnDescargarCSV" class="bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>Descargar CSV</span>
                    </button>
                    <button id="btnAgregarFila" class="bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>Agregar Fila</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="noAccess" class="hidden mb-8">
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 text-yellow-800 dark:text-yellow-200 p-6 rounded-xl shadow-lg">
                <div class="flex items-center">
                    <svg class="w-8 h-8 mr-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    <div>
                        <h3 class="text-xl font-bold">Acceso Restringido</h3>
                        <p>Esta sección es solo para administradores del sistema.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="panel" class="bg-darkcard rounded-2xl shadow-2xl border border-darkborder overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-darkcard border-b border-darkborder">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-primary-600 dark:text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <span>Edad</span>
                                </div>
                            </th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-primary-600 dark:text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <span>Sexo</span>
                                </div>
                            </th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-primary-600 dark:text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span>Especialidades</span>
                                </div>
                            </th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-primary-600 dark:text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span>Motivo de Consulta</span>
                                </div>
                            </th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-primary-600 dark:text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    <span>Acciones</span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="marketingTable" class="divide-y divide-gray-100 dark:divide-gray-800">
                        <tr id="loadingRow" class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                            <td colspan="5" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center space-y-3 text-gray-500 dark:text-gray-400">
                                    <svg class="w-12 h-12 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <div>
                                        <p class="text-lg font-medium">Listo para cargar datos</p>
                                        <p class="text-sm">Usa el botón "Agregar Fila" para comenzar</p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Mensaje informativo sobre guardado automático -->
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-4 m-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-blue-800 dark:text-blue-200 text-sm font-medium">
                            ☁️ Los datos se guardan automáticamente en la nube (Firebase). Podrás acceder desde cualquier dispositivo.
                        </span>
                    </div>
                    <div id="estadoSincronizacion" class="flex items-center space-x-2 text-xs">
                        <div id="indicadorSincronizacion" class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span id="textoSincronizacion" class="text-green-700 dark:text-green-300">Sincronizado</span>
                    </div>
                </div>
            </div>
            
            <!-- Botones adicionales -->
            <div class="flex justify-center space-x-4 p-6 border-t border-gray-200 dark:border-gray-700">
                <button onclick="agregarFila()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl text-sm font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span>Agregar Fila</span>
                </button>
                <button onclick="sincronizarDatos()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl text-sm font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>Sincronizar</span>
                </button>
                <button onclick="limpiarDatosMarketing()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl text-sm font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <span>Limpiar Todos los Datos</span>
                </button>
            </div>
        </div>
    </main>

    <script>
        const MOTIVOS_CONSULTA = [
            "Psicología Infantil",
            "Psicología Adolescente",
            "Psicología Adulto",
            "Psicología Familiar",
            "Psicología de Pareja",
            "Psicología Laboral",
            "Psicología Educativa",
            "Psicología Clínica",
            "Psicología Social",
            "Psicología Forense",
            "Psicología Deportiva",
            "Psicología de la Salud",
            "Neuropsicología",
            "Psicopedagogía",
            "Terapia Ocupacional",
            "Fonoaudiología",
            "Psicomotricidad",
            "Integración Sensorial",
            "Orientación Vocacional",
            "Apoyo Escolar"
        ];

        const MOTIVOS_ESPECIFICOS = [
            'Retraso en el lenguaje o en el desarrollo',
            'Trastornos del lenguaje (TDL)',
            'Sospecha Trastorno del espectro autista (TEA)',
            'Problemas de conducta',
            'Trastornos del sueño',
            'Ansiedad por separación / miedos intensos',
            'Síntomas somáticos (dolores, vómitos, regresiones)',
            'Regresiones evolutivas',
            'Hipersensibilidad sensorial o conductas repetitivas',
            'Problemas de atención / sospecha de TDAH',
            'Dificultades en el aprendizaje',
            'Dislexia',
            'Discalculia',
            'Disgrafía',
            'Problemas de concentracion',
            'Ansiedad escolar / fobia escolar',
            'Baja autoestima',
            'retraimiento social',
            'bullying',
            'Conflictos con figuras de autoridad',
            'Síntomas depresivos',
            'Celos entre hermanos',
            'Miedos intensos o trastornos obsesivos (rituales, manías)',
            'Consultas vinculadas a muerte, divorcio o mudanzas',
            'Depresión / síntomas depresivos / desmotivación',
            'Autolesiones',
            'Problemas con la imagen corporal',
            'Aislamiento social o problemas de vinculación con pares',
            'Identidad de género u orientación sexual',
            'Problemas de rendimiento escolar / abandono escolar',
            'Consultas por demanda de terceros (escuela, pediatra, padres separados)',
            'Situaciones de abuso (sexual, físico o emocional)',
            'Violencia familiar (presenciada o sufrida)',
            'Secretos Familiares (ocultar maternidad o paternidad)',
            'Dependencia o uso excesivo de pantallas',
            'Mutismo Selectivo',
            'No controla esfínteres',
            'TDL (Trastorno del desarrollo del lenguaje) severo',
            'TDL (Trastorno del desarrollo del lenguaje) moderado',
            'TDL (Trastorno del desarrollo del lenguaje) leve',
            'Mutismo (no TEA)',
            'TSH (Trastorno de los sonidos del habla)',
            'Tartamudez (Disfluencia)',
            'Respiración Bucal',
            'Deglución Disfuncional',
            'Afasia Global',
            'Afasia Mixta',
            'Afasia Expresiva',
            'Disartria',
            'Disfonía',
            'Apraxia del habla',
            'Trastorno Deglutorio',
            'Sobrepeso/Obesidad',
            'Bajo peso/Desnutrición',
            'Trastornos de la conducta alimentaria',
            'Alergias alimentarias',
            'Intolerancias alimentarias',
            'Diabetes',
            'Hipertensión arterial',
            'Dislipidemias',
            'Anemia',
            'Problemas digestivos',
            'Educación nutricional',
            'Planificación de menús',
            'Suplementación nutricional',
            'Ansiedad',
            'Depresión',
            'Estrés laboral',
            'Problemas de pareja',
            'Duelo',
            'Trastornos de personalidad',
            'Trastornos obsesivo-compulsivos',
            'Fobias',
            'Trastornos del sueño',
            'Problemas de autoestima',
            'Crisis vitales',
            'Trastornos adaptativos',
            'Problemas de comunicación',
            'Manejo de emociones',
            'Desarrollo personal',
            'Problemas de memoria',
            'Dificultades en comprensión lectora',
            'Problemas de razonamiento lógico',
            'Dificultades en matemáticas',
            'Problemas de organización y planificación',
            'Dificultades en expresión escrita',
            'Problemas de velocidad de procesamiento',
            'Dificultades visoespaciales',
            'Problemas de coordinación motora',
            'Evaluación psicopedagógica'
        ];

        function crearSelectorEspecialidades(especialidadesSeleccionadas = []) {
            const selector = crearSelectorGenerico(especialidadesSeleccionadas, MOTIVOS_CONSULTA, 'Especialidades');
            selector.classList.add('selector-especialidades');
            return selector;
        }

        function crearSelectorMotivos(motivosSeleccionados = []) {
            const selector = crearSelectorGenerico(motivosSeleccionados, MOTIVOS_ESPECIFICOS, 'Motivo de Consulta');
            selector.classList.add('selector-motivos');
            return selector;
        }

        function crearSelectorGenerico(elementosSeleccionados = [], listaElementos = [], titulo = 'Seleccionar') {
            const container = document.createElement('div');
            container.className = 'w-full';
            
            // Crear botón que abre/cierra el panel
            const botonSelector = document.createElement('button');
            botonSelector.type = 'button';
            botonSelector.className = 'w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 cursor-pointer text-left flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-600';
            
            const textoBoton = document.createElement('span');
            textoBoton.className = 'truncate';
            if (elementosSeleccionados.length === 0) {
                textoBoton.textContent = `Seleccionar ${titulo.toLowerCase()}...`;
            } else if (elementosSeleccionados.length === 1) {
                textoBoton.textContent = elementosSeleccionados[0];
            } else {
                textoBoton.textContent = `${elementosSeleccionados.length} ${titulo.toLowerCase()} seleccionados`;
            }
            
            const iconoFlecha = document.createElement('svg');
            iconoFlecha.className = 'w-5 h-5 text-gray-400 transition-transform duration-200 flex-shrink-0';
            iconoFlecha.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
            
            botonSelector.appendChild(textoBoton);
            botonSelector.appendChild(iconoFlecha);
            
            // Crear panel con checkboxes
            const panelSelector = document.createElement('div');
            panelSelector.className = 'mt-2 p-4 bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 rounded-xl shadow-lg max-h-64 overflow-y-auto';
            
            const tituloPanel = document.createElement('h4');
            tituloPanel.className = 'text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3';
            tituloPanel.textContent = `Seleccionar ${titulo.toLowerCase()}:`;
            panelSelector.appendChild(tituloPanel);
            
            // Crear checkboxes
            const checkboxesContainer = document.createElement('div');
            checkboxesContainer.className = 'space-y-2';
            
            const checkboxes = {};
            listaElementos.forEach(elemento => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = elemento;
                checkbox.checked = elementosSeleccionados.includes(elemento);
                checkbox.className = 'w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-600 dark:border-gray-500';
                
                const label = document.createElement('label');
                label.className = 'text-sm text-gray-700 dark:text-gray-300 cursor-pointer flex-1';
                label.textContent = elemento;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                checkboxesContainer.appendChild(div);
                
                checkboxes[elemento] = checkbox;
            });
            
            panelSelector.appendChild(checkboxesContainer);
            
            // Botones de acción
            const botonesContainer = document.createElement('div');
            botonesContainer.className = 'flex justify-between items-center mt-3 pt-3 border-t border-gray-200 dark:border-gray-600';
            
            const btnSeleccionarTodos = document.createElement('button');
            btnSeleccionarTodos.type = 'button';
            btnSeleccionarTodos.className = 'text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium transition-colors';
            btnSeleccionarTodos.textContent = 'Seleccionar todos';
            btnSeleccionarTodos.onclick = () => {
                Object.values(checkboxes).forEach(checkbox => {
                    checkbox.checked = true;
                });
                actualizarTextoBoton();
                guardarDatosMarketing();
            };
            
            const btnLimpiar = document.createElement('button');
            btnLimpiar.type = 'button';
            btnLimpiar.className = 'text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 font-medium transition-colors';
            btnLimpiar.textContent = 'Limpiar';
            btnLimpiar.onclick = () => {
                Object.values(checkboxes).forEach(checkbox => {
                    checkbox.checked = false;
                });
                actualizarTextoBoton();
                guardarDatosMarketing();
            };
            
            botonesContainer.appendChild(btnSeleccionarTodos);
            botonesContainer.appendChild(btnLimpiar);
            panelSelector.appendChild(botonesContainer);
            
            // Inicialmente oculto
            panelSelector.classList.add('hidden');
            
            container.appendChild(botonSelector);
            container.appendChild(panelSelector);
            
            const actualizarTextoBoton = () => {
                const elementosSeleccionados = Object.keys(checkboxes).filter(elemento => checkboxes[elemento].checked);
                if (elementosSeleccionados.length === 0) {
                    textoBoton.textContent = `Seleccionar ${titulo.toLowerCase()}...`;
                } else if (elementosSeleccionados.length === 1) {
                    textoBoton.textContent = elementosSeleccionados[0];
                } else {
                    textoBoton.textContent = `${elementosSeleccionados.length} ${titulo.toLowerCase()} seleccionados`;
                }
            };
            
            // Inicializar el texto del botón
            actualizarTextoBoton();
            
            // Evento para abrir/cerrar el panel
            botonSelector.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const estaAbierto = !panelSelector.classList.contains('hidden');
                
                if (estaAbierto) {
                    panelSelector.classList.add('hidden');
                    iconoFlecha.style.transform = 'rotate(0deg)';
                } else {
                    panelSelector.classList.remove('hidden');
                    iconoFlecha.style.transform = 'rotate(180deg)';
                }
            });
            
            // Evento para cerrar al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                    panelSelector.classList.add('hidden');
                    iconoFlecha.style.transform = 'rotate(0deg)';
                }
            });
            
            // Eventos para los checkboxes
            Object.values(checkboxes).forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    actualizarTextoBoton();
                    guardarDatosMarketing();
                });
            });
            
            container.getElementosSeleccionados = () => {
                return Object.keys(checkboxes).filter(elemento => checkboxes[elemento].checked);
            };
            
            return container;
        }

        function agregarFila() {
            const tbody = document.getElementById('marketingTable');
            const loadingRow = document.getElementById('loadingRow');
            
            if (loadingRow) {
                loadingRow.remove();
            }
            
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 dark:hover:bg-darkcard transition-all duration-200 border-b border-gray-100 dark:border-darkborder';
            
            const tdEdad = document.createElement('td');
            tdEdad.className = 'px-6 py-4';
            const inputEdad = document.createElement('input');
            inputEdad.type = 'number';
            inputEdad.className = 'w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 placeholder-gray-400 dark:placeholder-gray-500';
            inputEdad.placeholder = 'Ingresa la edad';
            inputEdad.min = '0';
            inputEdad.max = '120';
            inputEdad.addEventListener('change', guardarDatosMarketing);
            tdEdad.appendChild(inputEdad);
            
            const tdSexo = document.createElement('td');
            tdSexo.className = 'px-6 py-4';
            const selectSexo = document.createElement('select');
            selectSexo.className = 'w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 cursor-pointer';
            ['Masculino', 'Femenino', 'No binario', 'Prefiero no decir'].forEach(sexo => {
                const option = document.createElement('option');
                option.value = sexo;
                option.textContent = sexo;
                selectSexo.appendChild(option);
            });
            selectSexo.addEventListener('change', guardarDatosMarketing);
            tdSexo.appendChild(selectSexo);
            
            const tdEspecialidades = document.createElement('td');
            tdEspecialidades.className = 'px-6 py-4 relative';
            const selectEspecialidades = crearSelectorEspecialidades([]);
            tdEspecialidades.appendChild(selectEspecialidades);
            
            const tdMotivo = document.createElement('td');
            tdMotivo.className = 'px-6 py-4 relative';
            const selectMotivo = crearSelectorMotivos([]);
            tdMotivo.appendChild(selectMotivo);
            
            const tdAcciones = document.createElement('td');
            tdAcciones.className = 'px-6 py-4';
            const btnEliminar = document.createElement('button');
            btnEliminar.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center space-x-2';
            btnEliminar.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span>Eliminar</span>';
            btnEliminar.onclick = () => {
                tr.style.transform = 'scale(0.95)';
                tr.style.opacity = '0';
                setTimeout(() => {
                    tr.remove();
                    guardarDatosMarketing();
                }, 200);
            };
            tdAcciones.appendChild(btnEliminar);
            
            tr.appendChild(tdEdad);
            tr.appendChild(tdSexo);
            tr.appendChild(tdEspecialidades);
            tr.appendChild(tdMotivo);
            tr.appendChild(tdAcciones);
            
            tr.style.transform = 'translateY(20px)';
            tr.style.opacity = '0';
            tbody.appendChild(tr);
            
            setTimeout(() => {
                tr.style.transform = 'translateY(0)';
                tr.style.opacity = '1';
            }, 50);
        }

        function descargarCSV() {
            const tbody = document.getElementById('marketingTable');
            const filas = tbody.querySelectorAll('tr:not(#loadingRow)');
            
            if (filas.length === 0) {
                alert('No hay datos para exportar. Agrega al menos una fila.');
                return;
            }
            
            let csv = 'Edad,Sexo,Especialidades,Motivo de Consulta\n';
            
            filas.forEach(fila => {
                const edad = fila.querySelector('input[type="number"]')?.value || '';
                const sexo = fila.querySelector('select')?.value || '';
                
                const selectorEspecialidades = fila.querySelector('.selector-especialidades');
                let especialidades = '';
                
                if (selectorEspecialidades && selectorEspecialidades.getElementosSeleccionados) {
                    especialidades = selectorEspecialidades.getElementosSeleccionados().join('; ');
                }
                
                const selectorMotivos = fila.querySelector('.selector-motivos');
                let motivos = '';
                
                if (selectorMotivos && selectorMotivos.getElementosSeleccionados) {
                    motivos = selectorMotivos.getElementosSeleccionados().join('; ');
                }
                
                csv += `"${edad}","${sexo}","${especialidades}","${motivos}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'marketing_data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Función para mostrar estado de sincronización
        function mostrarEstadoSincronizacion(estado, mensaje) {
            const indicador = document.getElementById('indicadorSincronizacion');
            const texto = document.getElementById('textoSincronizacion');
            
            if (!indicador || !texto) return;
            
            // Remover clases anteriores
            indicador.className = 'w-2 h-2 rounded-full';
            texto.className = 'text-xs';
            
            switch (estado) {
                case 'sincronizando':
                    indicador.className += ' bg-yellow-500 animate-pulse';
                    texto.className += ' text-yellow-700 dark:text-yellow-300';
                    texto.textContent = 'Sincronizando...';
                    break;
                case 'sincronizado':
                    indicador.className += ' bg-green-500';
                    texto.className += ' text-green-700 dark:text-green-300';
                    texto.textContent = 'Sincronizado';
                    break;
                case 'error':
                    indicador.className += ' bg-red-500';
                    texto.className += ' text-red-700 dark:text-red-300';
                    texto.textContent = 'Error de sincronización';
                    break;
                case 'offline':
                    indicador.className += ' bg-gray-500';
                    texto.className += ' text-gray-700 dark:text-gray-300';
                    texto.textContent = 'Modo offline';
                    break;
            }
        }
        
        // Función para guardar datos de marketing en Firebase
        async function guardarDatosMarketing() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.error('Usuario no autenticado');
                    return;
                }
                
                // Mostrar estado de sincronización
                mostrarEstadoSincronizacion('sincronizando', 'Sincronizando...');
                
                const tbody = document.getElementById('marketingTable');
                const filas = tbody.querySelectorAll('tr:not(#loadingRow)');
                const datos = [];
                
                filas.forEach(fila => {
                    const edad = fila.querySelector('input[type="number"]')?.value || '';
                    const sexo = fila.querySelector('select')?.value || '';
                    
                    const selectorEspecialidades = fila.querySelector('.selector-especialidades');
                    let especialidades = [];
                    if (selectorEspecialidades && selectorEspecialidades.getElementosSeleccionados) {
                        especialidades = selectorEspecialidades.getElementosSeleccionados();
                    }
                    
                    const selectorMotivos = fila.querySelector('.selector-motivos');
                    let motivos = [];
                    if (selectorMotivos && selectorMotivos.getElementosSeleccionados) {
                        motivos = selectorMotivos.getElementosSeleccionados();
                    }
                    
                    if (edad || sexo || especialidades.length > 0 || motivos.length > 0) {
                        datos.push({
                            edad: edad,
                            sexo: sexo,
                            especialidades: especialidades,
                            motivos: motivos,
                            timestamp: Date.now()
                        });
                    }
                });
                
                // Guardar en Firebase
                await firebase.firestore()
                    .collection('usuarios')
                    .doc(user.uid)
                    .collection('marketing')
                    .doc('datos')
                    .set({
                        datos: datos,
                        ultimaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                console.log('Datos de marketing guardados en Firebase:', datos);
                
                // También guardar en localStorage como backup
                localStorage.setItem('datosMarketing', JSON.stringify(datos));
                
                // Mostrar estado exitoso
                mostrarEstadoSincronizacion('sincronizado', 'Sincronizado');
                
                // Ocultar el estado exitoso después de 3 segundos
                setTimeout(() => {
                    mostrarEstadoSincronizacion('sincronizado', 'Sincronizado');
                }, 3000);
                
            } catch (error) {
                console.error('Error al guardar en Firebase:', error);
                
                // Mostrar estado de error
                mostrarEstadoSincronizacion('error', 'Error de sincronización');
                
                // Fallback a localStorage si Firebase falla
                const tbody = document.getElementById('marketingTable');
                const filas = tbody.querySelectorAll('tr:not(#loadingRow)');
                const datos = [];
                
                filas.forEach(fila => {
                    const edad = fila.querySelector('input[type="number"]')?.value || '';
                    const sexo = fila.querySelector('select')?.value || '';
                    
                    const selectorEspecialidades = fila.querySelector('.selector-especialidades');
                    let especialidades = [];
                    if (selectorEspecialidades && selectorEspecialidades.getElementosSeleccionados) {
                        especialidades = selectorEspecialidades.getElementosSeleccionados();
                    }
                    
                    const selectorMotivos = fila.querySelector('.selector-motivos');
                    let motivos = [];
                    if (selectorMotivos && selectorMotivos.getElementosSeleccionados) {
                        motivos = selectorMotivos.getElementosSeleccionados();
                    }
                    
                    if (edad || sexo || especialidades.length > 0 || motivos.length > 0) {
                        datos.push({
                            edad: edad,
                            sexo: sexo,
                            especialidades: especialidades,
                            motivos: motivos
                        });
                    }
                });
                
                localStorage.setItem('datosMarketing', JSON.stringify(datos));
                console.log('Datos guardados en localStorage como fallback:', datos);
                
                // Mostrar mensaje de fallback
                mostrarMensaje('Los datos se guardaron localmente. Se sincronizarán cuando se restablezca la conexión.', 'warning');
                
                // Ocultar el estado de error después de 5 segundos
                setTimeout(() => {
                    mostrarEstadoSincronizacion('offline', 'Modo offline');
                }, 5000);
            }
        }
        
        // Función para cargar datos de marketing desde Firebase
        async function cargarDatosMarketing() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.error('Usuario no autenticado');
                    return;
                }
                
                // Intentar cargar desde Firebase primero
                const docRef = firebase.firestore()
                    .collection('usuarios')
                    .doc(user.uid)
                    .collection('marketing')
                    .doc('datos');
                
                const doc = await docRef.get();
                
                if (doc.exists) {
                    const datos = doc.data().datos || [];
                    console.log('Datos de marketing cargados desde Firebase:', datos);
                    
                    // Limpiar tabla existente
                    const tbody = document.getElementById('marketingTable');
                    const filasExistentes = tbody.querySelectorAll('tr:not(#loadingRow)');
                    filasExistentes.forEach(fila => fila.remove());
                    
                    // Agregar filas con datos guardados
                    datos.forEach(dato => {
                        agregarFilaConDatos(dato.edad, dato.sexo, dato.especialidades, dato.motivos);
                    });
                    
                    // Mostrar mensaje de datos cargados
                    if (datos.length > 0) {
                        mostrarMensaje(`Se cargaron ${datos.length} registros desde la nube`, 'success');
                    }
                    
                    // Actualizar localStorage con los datos de Firebase
                    localStorage.setItem('datosMarketing', JSON.stringify(datos));
                    
                } else {
                    // Si no hay datos en Firebase, intentar cargar desde localStorage
                    console.log('No hay datos en Firebase, intentando cargar desde localStorage...');
                    cargarDesdeLocalStorage();
                }
                
            } catch (error) {
                console.error('Error al cargar desde Firebase:', error);
                // Fallback a localStorage si Firebase falla
                console.log('Fallback a localStorage...');
                cargarDesdeLocalStorage();
            }
        }
        
        // Función para cargar desde localStorage como fallback
        function cargarDesdeLocalStorage() {
            const datosGuardados = localStorage.getItem('datosMarketing');
            if (datosGuardados) {
                try {
                    const datos = JSON.parse(datosGuardados);
                    console.log('Datos de marketing cargados desde localStorage:', datos);
                    
                    // Limpiar tabla existente
                    const tbody = document.getElementById('marketingTable');
                    const filasExistentes = tbody.querySelectorAll('tr:not(#loadingRow)');
                    filasExistentes.forEach(fila => fila.remove());
                    
                    // Agregar filas con datos guardados
                    datos.forEach(dato => {
                        agregarFilaConDatos(dato.edad, dato.sexo, dato.especialidades, dato.motivos);
                    });
                    
                    // Mostrar mensaje de datos cargados
                    if (datos.length > 0) {
                        mostrarMensaje(`Se cargaron ${datos.length} registros desde el navegador local`, 'info');
                    }
                } catch (error) {
                    console.error('Error al cargar datos de localStorage:', error);
                    localStorage.removeItem('datosMarketing');
                }
            }
        }
        
        // Función para agregar fila con datos pre-cargados
        function agregarFilaConDatos(edad = '', sexo = '', especialidades = [], motivos = []) {
            const tbody = document.getElementById('marketingTable');
            const fila = document.createElement('tr');
            fila.className = 'hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors';
            
            // Columna Edad
            const tdEdad = document.createElement('td');
            tdEdad.className = 'px-6 py-4';
            const inputEdad = document.createElement('input');
            inputEdad.type = 'number';
            inputEdad.min = '0';
            inputEdad.max = '120';
            inputEdad.className = 'w-20 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white text-center';
            inputEdad.value = edad;
            inputEdad.addEventListener('change', guardarDatosMarketing);
            tdEdad.appendChild(inputEdad);
            
            // Columna Sexo
            const tdSexo = document.createElement('td');
            tdSexo.className = 'px-6 py-4';
            const selectSexo = document.createElement('select');
            selectSexo.className = 'px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white';
            selectSexo.addEventListener('change', guardarDatosMarketing);
            
            const opcionesSexo = ['', 'Masculino', 'Femenino', 'No binario', 'Prefiero no decir'];
            opcionesSexo.forEach(opcion => {
                const option = document.createElement('option');
                option.value = opcion;
                option.textContent = opcion;
                if (opcion === sexo) option.selected = true;
                selectSexo.appendChild(option);
            });
            tdSexo.appendChild(selectSexo);
            
            // Columna Especialidades
            const tdEspecialidades = document.createElement('td');
            tdEspecialidades.className = 'px-6 py-4 relative';
            const selectEspecialidades = crearSelectorEspecialidades(especialidades);
            tdEspecialidades.appendChild(selectEspecialidades);
            
            // Columna Motivo de Consulta
            const tdMotivo = document.createElement('td');
            tdMotivo.className = 'px-6 py-4 relative';
            const selectMotivo = crearSelectorMotivos(motivos);
            tdMotivo.appendChild(selectMotivo);
            
            // Columna Acciones
            const tdAcciones = document.createElement('td');
            tdAcciones.className = 'px-6 py-4 text-center';
            const btnEliminar = document.createElement('button');
            btnEliminar.className = 'text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 transition-colors';
            btnEliminar.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>';
            btnEliminar.addEventListener('click', () => {
                fila.remove();
                guardarDatosMarketing();
            });
            tdAcciones.appendChild(btnEliminar);
            
            fila.appendChild(tdEdad);
            fila.appendChild(tdSexo);
            fila.appendChild(tdEspecialidades);
            fila.appendChild(tdMotivo);
            fila.appendChild(tdAcciones);
            
            tbody.appendChild(fila);
        }

        async function verificarAdmin() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    window.location.href = 'index.html';
                    return;
                }
                
                const userDoc = await firebase.firestore().collection('usuarios').doc(user.uid).get();
                
                if (!userDoc.exists || !userDoc.data().isAdmin) {
                    document.getElementById('noAccess').classList.remove('hidden');
                    document.getElementById('panel').classList.add('hidden');
                    return;
                }
                
                document.getElementById('noAccess').classList.add('hidden');
                document.getElementById('panel').classList.remove('hidden');
                
                // Inicializar estado de sincronización
                mostrarEstadoSincronizacion('sincronizando', 'Cargando...');
                
                // Cargar datos al iniciar la página
                cargarDatosMarketing().then(() => {
                    mostrarEstadoSincronizacion('sincronizado', 'Sincronizado');
                }).catch(() => {
                    mostrarEstadoSincronizacion('offline', 'Modo offline');
                });
            } catch (error) {
                console.error('Error verificando admin:', error);
                document.getElementById('noAccess').classList.remove('hidden');
                document.getElementById('panel').classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    verificarAdmin();
                } else {
                    window.location.href = 'index.html';
                }
            });
            
            document.getElementById('btnAgregarFila').addEventListener('click', agregarFila);
            document.getElementById('btnDescargarCSV').addEventListener('click', descargarCSV);
            document.getElementById('logoutBtn').addEventListener('click', () => {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                });
            });
        });

        // Función para limpiar todos los datos de marketing
        async function limpiarDatosMarketing() {
            if (confirm('¿Estás seguro de que quieres eliminar todos los datos de marketing? Esta acción no se puede deshacer.')) {
                try {
                    const user = firebase.auth().currentUser;
                    if (user) {
                        // Limpiar Firebase
                        await firebase.firestore()
                            .collection('usuarios')
                            .doc(user.uid)
                            .collection('marketing')
                            .doc('datos')
                            .delete();
                        console.log('Datos eliminados de Firebase');
                    }
                } catch (error) {
                    console.error('Error al eliminar de Firebase:', error);
                }
                
                // Limpiar localStorage
                localStorage.removeItem('datosMarketing');
                
                // Limpiar tabla
                const tbody = document.getElementById('marketingTable');
                const filasExistentes = tbody.querySelectorAll('tr:not(#loadingRow)');
                filasExistentes.forEach(fila => fila.remove());
                
                // Mostrar fila de carga
                const loadingRow = document.getElementById('loadingRow');
                if (loadingRow) {
                    loadingRow.style.display = 'table-row';
                }
                
                mostrarMensaje('Todos los datos de marketing han sido eliminados de la nube y localmente', 'success');
            }
        }
        
        // Función para sincronizar datos manualmente
        async function sincronizarDatos() {
            try {
                mostrarEstadoSincronizacion('sincronizando', 'Sincronizando...');
                
                // Primero intentar cargar desde Firebase
                await cargarDatosMarketing();
                
                // Luego guardar los datos actuales
                await guardarDatosMarketing();
                
                mostrarMensaje('Datos sincronizados exitosamente', 'success');
                
            } catch (error) {
                console.error('Error al sincronizar:', error);
                mostrarEstadoSincronizacion('error', 'Error de sincronización');
                mostrarMensaje('Error al sincronizar los datos', 'error');
                
                // Ocultar el estado de error después de 5 segundos
                setTimeout(() => {
                    mostrarEstadoSincronizacion('offline', 'Modo offline');
                }, 5000);
            }
        }
        
        // Función para mostrar mensajes al usuario
        function mostrarMensaje(mensaje, tipo = 'info') {
            // Crear elemento de mensaje
            const mensajeElement = document.createElement('div');
            mensajeElement.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
            
            // Estilos según el tipo
            switch (tipo) {
                case 'success':
                    mensajeElement.className += ' bg-green-500 text-white';
                    break;
                case 'error':
                    mensajeElement.className += ' bg-red-500 text-white';
                    break;
                case 'warning':
                    mensajeElement.className += ' bg-yellow-500 text-white';
                    break;
                default:
                    mensajeElement.className += ' bg-blue-500 text-white';
            }
            
            mensajeElement.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span>${mensaje}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            // Agregar al DOM
            document.body.appendChild(mensajeElement);
            
            // Animar entrada
            setTimeout(() => {
                mensajeElement.classList.remove('translate-x-full');
            }, 100);
            
            // Auto-eliminar después de 5 segundos
            setTimeout(() => {
                if (mensajeElement.parentElement) {
                    mensajeElement.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (mensajeElement.parentElement) {
                            mensajeElement.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }
    </script>
</body>
</html>

